<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard</title>
  <style>
    body { margin: 0; font-family: Segoe UI; background: #f4f6fb; }
    .sidebar {
      position: fixed; left: 0; top: 0; width: 220px; height: 100%;
      background: #2c3e50; color: white; padding: 20px;
    }
    .main { margin-left: 240px; padding: 25px; }
    .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,.1); }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
    th { background: #1abc9c; color: white; cursor: pointer; user-select: none; position: relative; }
    th::after { content: '‚Üï'; position: absolute; right: 8px; opacity: 0.4; }
    th.asc::after { content: '‚Üë'; opacity: 1; }
    th.desc::after { content: '‚Üì'; opacity: 1; }
    .loading { display: none; margin: 15px 0; }
    .spinner {
      width: 20px; height: 20px; border: 3px solid #ccc;
      border-top: 3px solid #1abc9c; border-radius: 50%;
      animation: spin 1s linear infinite; display: inline-block;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .controls { margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    #searchInput { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 200px; }
    .pagination {
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    button {
      padding: 8px 12px; border: none; border-radius: 6px;
      cursor: pointer; background: #1abc9c; color: white;
    }
    button:disabled {
      background: #bdc3c7; cursor: not-allowed;
    }
    .logout { background: #e74c3c; width: 100%; margin-top: 20px; }
    .error { color: #e74c3c; text-align: center; padding: 20px; }
  </style>
</head>
<body>

<div class="sidebar">
  <h2>üëë Admin</h2>
  <p>Manajemen Anggota</p>
  <button class="logout" onclick="logout()">üîÅ Ganti User</button>
</div>

<div class="main">
  <div class="card">
    <h3>üìã Data Anggota</h3>

    <div class="controls">
      <input type="text" id="searchInput" placeholder="Cari NIM, nama, email, alamat..." />
    </div>

    <div class="loading" id="loading">
      <span class="spinner"></span> Memuat data...
    </div>

    <table id="dataTable">
      <thead>
        <tr>
          <th data-field="nim">NIM</th>
          <th data-field="nama">Nama</th>
          <th data-field="email">Email</th>
          <th data-field="no_hp">No HP</th>
          <th data-field="alamat">Alamat</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="pagination" id="paginationSection" style="display:none;">
      <button id="prev" onclick="prevPage()" disabled>‚Üê Sebelumnya</button>
      <span id="pageInfo">Halaman 1</span>
      <button id="next" onclick="nextPage()" disabled>Berikutnya ‚Üí</button>
    </div>
  </div>
</div>

<script>
  // State manajemen
  const state = {
    page: 1,
    search: '',
    sortBy: 'nim',
    order: 'asc'
  };

  // Ambil elemen
  const searchInput = document.getElementById('searchInput');
  const tbody = document.getElementById('tbody');
  const loading = document.getElementById('loading');
  const dataTable = document.getElementById('dataTable');
  const paginationSection = document.getElementById('paginationSection');

  // Setup event listener
  searchInput.addEventListener('input', (e) => {
    state.search = e.target.value;
    state.page = 1;
    load();
  });

  document.querySelectorAll('th[data-field]').forEach(th => {
    th.addEventListener('click', () => {
      const field = th.dataset.field;
      if (state.sortBy === field) {
        state.order = state.order === 'asc' ? 'desc' : 'asc';
      } else {
        state.sortBy = field;
        state.order = 'asc';
      }
      state.page = 1;
      load();
    });
  });

  async function load() {
    const role = localStorage.getItem('role');
    if (!role) {
      showErrorMessage('Anda belum login. Silakan login terlebih dahulu.');
      return;
    }

    loading.style.display = 'block';
    tbody.innerHTML = '';
    paginationSection.style.display = 'none';

    try {
      const params = new URLSearchParams({
        page: state.page,
        search: state.search,
        sortBy: state.sortBy,
        order: state.order
      });

      const res = await fetch(`/admin/anggota?${params}`, {
        headers: { 'x-role': role } // Kirim role sesuai localStorage
      });

      if (res.status === 403) {
        showErrorMessage('‚ùå Akses ditolak (Error 403 Forbidden). Anda tidak memiliki izin sebagai Admin.');
        return;
      }

      if (!res.ok) {
        throw new Error(`Server error: ${res.status}`);
      }

      const result = await res.json();

      // Render data
      if (result.data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#777">Tidak ada data ditemukan</td></tr>`;
      } else {
        result.data.forEach(a => {
          tbody.innerHTML += `
            <tr>
              <td>${a.nim || ''}</td>
              <td>${a.nama || ''}</td>
              <td>${a.email || ''}</td>
              <td>${a.no_hp || ''}</td>
              <td>${a.alamat || ''}</td>
            </tr>`;
        });
      }

      // Tampilkan navigasi pagination
      const { currentPage, totalPages } = result.pagination;
      document.getElementById('pageInfo').textContent = `Halaman ${currentPage} dari ${totalPages}`;
      document.getElementById('prev').disabled = currentPage <= 1;
      document.getElementById('next').disabled = currentPage >= totalPages;
      paginationSection.style.display = 'flex';

      // Update visual sort
      document.querySelectorAll('th[data-field]').forEach(th => {
        th.classList.remove('asc', 'desc');
        if (th.dataset.field === state.sortBy) {
          th.classList.add(state.order);
        }
      });

    } catch (err) {
      console.error(err);
      showErrorMessage('Gagal memuat data dari server.');
    }

    loading.style.display = 'none';
  }

  function showErrorMessage(message) {
    tbody.innerHTML = `<tr><td colspan="5" class="error">${message}</td></tr>`;
    paginationSection.style.display = 'none';
    loading.style.display = 'none';
  }

  function prevPage() {
    if (state.page > 1) {
      state.page--;
      load();
    }
  }

  function nextPage() {
    state.page++;
    load();
  }

  function logout() {
    localStorage.clear();
    alert('Anda telah logout.');
    location.href = '/login.html';
  }

  // Muat data saat halaman dibuka ‚Äî SIAPA PUN BISA BUKA HALAMAN INI
  load();
</script>
</body>
</html>